# Azure Developer CLI (azd) configuration
name: aks-journal-app
metadata:
  template: aks-journal-app@1.0.0

hooks:
  preprovision:
    shell: sh
    run: echo "Provisioning AKS infrastructure with Azure Monitor..."
  
  postprovision:
    shell: sh
    run: |
      echo "Getting AKS credentials..."
      az aks get-credentials --resource-group ${AZURE_RESOURCE_GROUP} --name ${AZURE_AKS_CLUSTER_NAME} --overwrite-existing
      
      echo "Creating namespace..."
      kubectl create namespace aks-journal-app --dry-run=client -o yaml | kubectl apply -f -
      
      echo "Creating Redis secret..."
      kubectl create secret generic redis-secret \
        --from-literal=REDIS_PASSWORD="${AZURE_REDIS_PASSWORD}" \
        -n aks-journal-app \
        --dry-run=client -o yaml | kubectl apply -f -
      
      echo "Configuring NSG rules for external access..."
      MC_RG="MC_${AZURE_RESOURCE_GROUP}_${AZURE_AKS_CLUSTER_NAME}_${AZURE_LOCATION}"
      NSG_NAME=$(az network nsg list --resource-group "$MC_RG" --query "[0].name" -o tsv 2>/dev/null)
      
      if [ -n "$NSG_NAME" ]; then
        echo "Adding HTTP inbound rule to NSG: $NSG_NAME"
        az network nsg rule create \
          --resource-group "$MC_RG" \
          --nsg-name "$NSG_NAME" \
          --name AllowHTTPInbound \
          --priority 200 \
          --direction Inbound \
          --access Allow \
          --protocol Tcp \
          --destination-port-ranges 80 443 \
          --source-address-prefixes '*' \
          --destination-address-prefixes '*' \
          -o none 2>/dev/null || echo "HTTP rule may already exist"
        
        az network nsg rule create \
          --resource-group "$MC_RG" \
          --nsg-name "$NSG_NAME" \
          --name AllowNodePortInbound \
          --priority 201 \
          --direction Inbound \
          --access Allow \
          --protocol Tcp \
          --destination-port-ranges 30000-32767 \
          --source-address-prefixes '*' \
          --destination-address-prefixes '*' \
          -o none 2>/dev/null || echo "NodePort rule may already exist"
        
        echo "NSG rules configured successfully"
      else
        echo "Warning: Could not find NSG in managed resource group"
      fi
      
      echo ""
      echo "Building and deploying application..."
      
      # Build and push Docker image (for linux/amd64 to run on AKS)
      ACR_NAME="${AZURE_CONTAINER_REGISTRY_NAME}"
      IMAGE_TAG="azd-deploy-$(date +%s)"
      IMAGE_NAME="${AZURE_CONTAINER_REGISTRY_ENDPOINT}/aks-journal-app/api:${IMAGE_TAG}"
      
      echo "Logging into ACR: ${ACR_NAME}..."
      az acr login --name "${ACR_NAME}"
      
      echo "Building Docker image for linux/amd64..."
      docker build --platform linux/amd64 -t "${IMAGE_NAME}" ./src/api
      
      echo "Pushing image to ACR..."
      docker push "${IMAGE_NAME}"
      
      echo "Deploying to AKS..."
      cat <<EOF | kubectl apply -f -
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: aks-journal
        namespace: aks-journal-app
        labels:
          app: aks-journal
      spec:
        replicas: 3
        selector:
          matchLabels:
            app: aks-journal
        template:
          metadata:
            labels:
              app: aks-journal
          spec:
            containers:
              - name: journal
                image: ${IMAGE_NAME}
                ports:
                  - containerPort: 3000
                env:
                  - name: NODE_ENV
                    value: production
                  - name: PORT
                    value: "3000"
                  - name: REDIS_HOST
                    value: "${AZURE_REDIS_HOST}"
                  - name: REDIS_PORT
                    value: "${AZURE_REDIS_PORT}"
                  - name: REDIS_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: redis-secret
                        key: REDIS_PASSWORD
                  - name: REDIS_TLS
                    value: "true"
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                  - name: NODE_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: spec.nodeName
                  - name: NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                resources:
                  requests:
                    memory: 128Mi
                    cpu: 100m
                  limits:
                    memory: 512Mi
                    cpu: 500m
                livenessProbe:
                  httpGet:
                    path: /live
                    port: 3000
                  initialDelaySeconds: 10
                  periodSeconds: 15
                readinessProbe:
                  httpGet:
                    path: /ready
                    port: 3000
                  initialDelaySeconds: 5
                  periodSeconds: 10
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: aks-journal
        namespace: aks-journal-app
      spec:
        type: LoadBalancer
        ports:
          - port: 80
            targetPort: 3000
        selector:
          app: aks-journal
      EOF
      
      echo "Waiting for deployment to be ready..."
      kubectl rollout status deployment/aks-journal -n aks-journal-app --timeout=120s
      
      echo ""
      echo "========================================="
      echo "Deployment complete!"
      echo "========================================="
      echo ""
      kubectl get pods -n aks-journal-app
      echo ""
      sleep 5
      EXTERNAL_IP=$(kubectl get svc aks-journal -n aks-journal-app -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
      if [ -n "$EXTERNAL_IP" ]; then
        echo "App is available at:"
        echo "  Health:   http://${EXTERNAL_IP}/health"
        echo "  Journals: http://${EXTERNAL_IP}/api/journals/<userId>"
        echo ""
        echo "Testing health endpoint..."
        curl -s --max-time 10 "http://${EXTERNAL_IP}/health" || echo ""
        echo ""
        echo "If external access is blocked, use port-forward:"
        echo "  kubectl port-forward svc/aks-journal -n aks-journal-app 8080:80"
        echo "  curl http://localhost:8080/health"
      else
        echo "LoadBalancer IP:"
        kubectl get svc aks-journal -n aks-journal-app
        echo ""
        echo "Use port-forward to test:"
        echo "  kubectl port-forward svc/aks-journal -n aks-journal-app 8080:80"
      fi

infra:
  provider: bicep
  path: infra
